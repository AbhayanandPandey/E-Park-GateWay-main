<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Admin Panel - E-Park Gateway</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			background-color: #f8f9fa;
		}

		.login-card {
			max-width: 400px;
			margin: 100px auto;
			padding: 30px;
			border-radius: 10px;
			background: #fff;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		#adminPanel {
			padding: 30px;
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body class="bg-light p-4">

	<div class="container ">
		<h2 class="mb-4 text-center ">Admin Login</h2>
		<div class="login-card" id="loginCard">
			<div id="loginForm">
				<input id="username" class="form-control mb-3" placeholder="Username">
				<input id="password" type="password" class="form-control mb-3" placeholder="Password">
				<button class="btn btn-primary w-100" onclick="login()">Login</button>
			</div>
		</div>
		<div id="adminPanel" class="d-none">
			<h3 class="mt-4">Users</h3>
			<table class="table table-bordered" id="userTable">
				<thead class="table-dark">
					<tr>
						<th>Name</th>
						<th>Email</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>

			<div id="userDetails" class="mt-5 d-none">
				<h4>User Details</h4>
				<table class="table table-striped table-bordered">
					<tbody id="detailsTable"></tbody>
				</table>
				<h5 class="mt-4">Products</h5>
				<table class="table table-bordered">
					<thead class="table-secondary">
						<tr>
							<th>Product ID</th>
							<th>Name</th>
							<th>Price</th>
							<th>Date</th>
							<th>Image</th>
						</tr>
					</thead>
					<tbody id="productTable"></tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		let token = '';

		async function login() {
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;

			const res = await fetch('/admin/login', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ username, password })
			});

			const data = await res.json();
			if (data.token) {
				token = data.token;
				document.getElementById('loginCard').classList.add('d-none');
				document.getElementById('adminPanel').classList.remove('d-none');
				loadUsers();
			} else {
				alert('Login failed');
			}
		}

		async function loadUsers() {
			const res = await fetch('/admin/users', {
				headers: { Authorization: 'Bearer ' + token }
			});
			const users = await res.json();
			const tbody = document.querySelector('#userTable tbody');
			tbody.innerHTML = '';

			users.forEach(user => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
          <td><a href="#" onclick="getDetails('${user.email}')">${user.User_name}</a></td>
          <td><a href="#" onclick="getDetails('${user.email}')">${user.email}</a></td>
        `;
				tbody.appendChild(tr);
			});
		}

		async function getDetails(email) {
			const res = await fetch('/admin/userDetails', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					Authorization: 'Bearer ' + token
				},
				body: JSON.stringify({ email })
			});

			const user = await res.json();
			const detailsTable = document.getElementById('detailsTable');
			const productTable = document.getElementById('productTable');

			// Display user basic details
			detailsTable.innerHTML = `
        <tr><th>Name</th><td>${user.User_name}</td></tr>
        <tr><th>Email</th><td>${user.email}</td></tr>
        <tr><th>Password</th><td>${user.password}</td></tr>
        <tr><th>Last Login</th><td>${new Date(user.lastLogin).toLocaleString()}</td></tr>
      `;

			// Display user products
			productTable.innerHTML = user.products.map(p => `
        <tr>
          <td>${p.productID}</td>
          <td>${p.productName}</td>
          <td>â‚¹${p.productPrice}</td>
          <td>${new Date(p.productDate).toLocaleDateString()}</td>
          <td>${p.productImage ? `<img src="${p.productImage}" height="50">` : 'N/A'}</td>
        </tr>
      `).join('');

			document.getElementById('userDetails').classList.remove('d-none');
		}
	</script>

</body>

</html>